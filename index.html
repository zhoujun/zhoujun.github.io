<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="If we dream, everything is possible.">
<meta property="og:type" content="website">
<meta property="og:title" content="Finger's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Finger's Blog">
<meta property="og:description" content="If we dream, everything is possible.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Finger's Blog">
<meta name="twitter:description" content="If we dream, everything is possible.">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>

  <title> Finger's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?f72f3a882d988aa169cd1c83da94a390";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Finger's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/12/elasticsearch-dsl-with-python-usage-1/" itemprop="url">
                  Python Elasticsearch DSL 使用笔记(一)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-08-12T20:39:00+08:00" content="2017-08-12">
              2017-08-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">elasticsearch</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/elasticsearch/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/08/12/elasticsearch-dsl-with-python-usage-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/12/elasticsearch-dsl-with-python-usage-1/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p><strong>下载地址</strong>: <a href="https://www.elastic.co/downloads/elasticsearch" target="_blank" rel="external">https://www.elastic.co/downloads/elasticsearch</a></p>
<p><strong>使用版本</strong>: elasticsearch-5.5.1</p>
<p><strong>Python Elasticsearch DSL</strong>: <a href="https://github.com/elastic/elasticsearch-dsl-py" target="_blank" rel="external">https://github.com/elastic/elasticsearch-dsl-py</a></p>
<h3 id="一、Elasticsearch的基本概念"><a href="#一、Elasticsearch的基本概念" class="headerlink" title="一、Elasticsearch的基本概念"></a>一、Elasticsearch的基本概念</h3><ul>
<li>Index：Elasticsearch用来存储数据的逻辑区域，它类似于关系型数据库中的database 概念。一个index可以在一个或者多个shard上面，同时一个shard也可能会有多个replicas。</li>
<li>Document：Elasticsearch里面存储的实体数据，类似于关系数据中一个table里面的一行数据。 document由多个field组成，不同的document里面同名的field一定具有相同的类型。document里面field可以重复出现，也就是一个field会有多个值，即multivalued。</li>
<li>Document type：为了查询需要，一个index可能会有多种document，也就是document type. 它类似于关系型数据库中的 table 概念。但需要注意，不同document里面同名的field一定要是相同类型的。</li>
<li>Mapping：它类似于关系型数据库中的 schema 定义概念。存储field的相关映射信息，不同document type会有不同的mapping。</li>
</ul>
<p>下图是ElasticSearch和关系型数据库的一些术语比较：</p>
<table>
<thead>
<tr>
<th>Relationnal database</th>
<th style="text-align:left">Elasticsearch           </th>
</tr>
</thead>
<tbody>
<tr>
<td>Database</td>
<td style="text-align:left">Index          </td>
</tr>
<tr>
<td>Table</td>
<td style="text-align:left">Type             </td>
</tr>
<tr>
<td>Row</td>
<td style="text-align:left">Document          </td>
</tr>
<tr>
<td>Column</td>
<td style="text-align:left">Field            </td>
</tr>
<tr>
<td>Schema</td>
<td style="text-align:left">Mapping        </td>
</tr>
<tr>
<td>Index</td>
<td style="text-align:left">Everything is indexed       </td>
</tr>
<tr>
<td>SQL</td>
<td style="text-align:left">Query DSL       </td>
</tr>
<tr>
<td>SELECT * FROM table…</td>
<td style="text-align:left">GET http://…  </td>
</tr>
<tr>
<td>UPDATE table SET</td>
<td style="text-align:left">PUT http://…   </td>
</tr>
</tbody>
</table>
<h3 id="二、Python-Elasticsearch-DSL使用简介-一"><a href="#二、Python-Elasticsearch-DSL使用简介-一" class="headerlink" title="二、Python Elasticsearch DSL使用简介(一)"></a>二、Python Elasticsearch DSL使用简介(一)</h3><h4 id="1、安装"><a href="#1、安装" class="headerlink" title="1、安装"></a>1、安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pip install elasticsearch-dsl</div></pre></td></tr></table></figure>
<h4 id="2、创建索引和文档"><a href="#2、创建索引和文档" class="headerlink" title="2、创建索引和文档"></a>2、创建索引和文档</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"><span class="keyword">from</span> elasticsearch_dsl <span class="keyword">import</span> DocType, Date, Integer, Keyword, Text</div><div class="line"><span class="keyword">from</span> elasticsearch_dsl.connections <span class="keyword">import</span> connections</div><div class="line"></div><div class="line"><span class="comment"># Define a default Elasticsearch client</span></div><div class="line">connections.create_connection(hosts=[<span class="string">'localhost'</span>])</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(DocType)</span>:</span></div><div class="line">    title = Text(analyzer=<span class="string">'snowball'</span>, fields=&#123;<span class="string">'raw'</span>: Keyword()&#125;)</div><div class="line">    body = Text(analyzer=<span class="string">'snowball'</span>)</div><div class="line">    tags = Keyword()</div><div class="line">    published_from = Date()</div><div class="line">    lines = Integer()</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        index = <span class="string">'blog'</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self, ** kwargs)</span>:</span></div><div class="line">        self.lines = len(self.body.split())</div><div class="line">        <span class="keyword">return</span> super(Article, self).save(** kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_published</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> datetime.now() &gt;= self.published_from</div><div class="line"></div><div class="line"><span class="comment"># create the mappings in elasticsearch</span></div><div class="line">Article.init()</div></pre></td></tr></table></figure>
<p>创建了一个索引为blog，文档为article的Elasticsearch数据库和表。<br>必须执行<code>Article.init()</code>方法。 这样Elasticsearch才会根据你的DocType产生对应的Mapping。否则Elasticsearch就会在你第一次创建Index和Type的时候根据你的内容建立对应的Mapping。</p>
<p>现在我们可以通过Elasticsearch Restful API来检查<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">http GET http://127.0.0.1:9200/blog/_mapping/</div><div class="line"></div><div class="line">&#123;&quot;blog&quot;:</div><div class="line">	&#123;&quot;mappings&quot;:</div><div class="line">		&#123;&quot;article&quot;:</div><div class="line">			&#123;&quot;properties&quot;:&#123;</div><div class="line">				&quot;body&quot;:&#123;&quot;type&quot;:&quot;text&quot;,&quot;analyzer&quot;:&quot;snowball&quot;&#125;,</div><div class="line">				&quot;lines&quot;:&#123;&quot;type&quot;:&quot;integer&quot;&#125;,</div><div class="line">				&quot;published_from&quot;:&#123;&quot;type&quot;:&quot;date&quot;&#125;,</div><div class="line">				&quot;tags&quot;:&#123;&quot;type&quot;:&quot;keyword&quot;&#125;,</div><div class="line">				&quot;title&quot;:&#123;&quot;type&quot;:&quot;text&quot;,&quot;fields&quot;:&#123;&quot;raw&quot;:&#123;&quot;type&quot;:&quot;keyword&quot;&#125;&#125;,&quot;analyzer&quot;:&quot;snowball&quot;&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="三、使用Elasticsearch进行CRUD操作"><a href="#三、使用Elasticsearch进行CRUD操作" class="headerlink" title="三、使用Elasticsearch进行CRUD操作"></a>三、使用Elasticsearch进行CRUD操作</h3><h4 id="1、Create-a-article"><a href="#1、Create-a-article" class="headerlink" title="1、Create a article"></a>1、Create a article</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># create and save and article</span></div><div class="line">article = Article(meta=&#123;<span class="string">'id'</span>: <span class="number">1</span>&#125;, title=<span class="string">'Hello elasticsearch!'</span>, tags=[<span class="string">'elasticsearch'</span>])</div><div class="line">article.body = <span class="string">''' looong text '''</span></div><div class="line">article.published_from = datetime.now()</div><div class="line">article.save()</div></pre></td></tr></table></figure>
<p>=&gt;Restful API<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">http POST http://127.0.0.1:9200/blog/article/1 title=&quot;hello elasticsearch&quot; tags:=&apos;[&quot;elasticsearch&quot;]&apos;</div><div class="line"></div><div class="line">HTTP/1.1 201 Created</div><div class="line">Content-Length: 73</div><div class="line">Content-Type: application/json; charset=UTF-8</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;_id&quot;: &quot;1&quot;, </div><div class="line">    &quot;_index&quot;: &quot;blog&quot;, </div><div class="line">    &quot;_type&quot;: &quot;article&quot;, </div><div class="line">    &quot;_version&quot;: 1, </div><div class="line">    &quot;created&quot;: true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="2、Get-a-article"><a href="#2、Get-a-article" class="headerlink" title="2、Get a article"></a>2、Get a article</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">article = Article.get(id=<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="comment"># 如果获取一个不存在的文章则返回None</span></div><div class="line">a = Article.get(id=<span class="string">'no-in-es'</span>)</div><div class="line">a <span class="keyword">is</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="comment"># 还可以获取多个文章</span></div><div class="line">articles = Article.mget([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</div></pre></td></tr></table></figure>
<p>=&gt;Restful API<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">http GET http://127.0.0.1:9200/blog/article/1</div><div class="line"></div><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Length: 141</div><div class="line">Content-Type: application/json; charset=UTF-8</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;_id&quot;: &quot;1&quot;, </div><div class="line">    &quot;_index&quot;: &quot;blog&quot;, </div><div class="line">    &quot;_source&quot;: &#123;</div><div class="line">        &quot;tags&quot;: [</div><div class="line">            &quot;elasticsearch&quot;</div><div class="line">        ], </div><div class="line">        &quot;title&quot;: &quot;hello elasticsearch&quot;</div><div class="line">    &#125;, </div><div class="line">    &quot;_type&quot;: &quot;article&quot;, </div><div class="line">    &quot;_version&quot;: 1, </div><div class="line">    &quot;found&quot;: true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="3、Update-a-article"><a href="#3、Update-a-article" class="headerlink" title="3、Update a article"></a>3、Update a article</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">article = Article.get(id=<span class="number">1</span>)</div><div class="line">article.tags = [<span class="string">'elasticsearch'</span>, <span class="string">'hello'</span>]</div><div class="line">article.save()</div><div class="line"></div><div class="line"><span class="comment"># 或者</span></div><div class="line">article.update(body=<span class="string">'Today is good day!'</span>, published_by=<span class="string">'me'</span>)</div></pre></td></tr></table></figure>
<p>=&gt;Restful API<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">http PUT http://127.0.0.1:9200/blog/article/1 title=&quot;hello elasticsearch&quot; tags:=&apos;[&quot;elasticsearch&quot;, &quot;hello&quot;]&apos;</div><div class="line"></div><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Length: 74</div><div class="line">Content-Type: application/json; charset=UTF-8</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;_id&quot;: &quot;1&quot;, </div><div class="line">    &quot;_index&quot;: &quot;blog&quot;, </div><div class="line">    &quot;_type&quot;: &quot;article&quot;, </div><div class="line">    &quot;_version&quot;: 2, </div><div class="line">    &quot;created&quot;: false</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="4、Delete-a-article"><a href="#4、Delete-a-article" class="headerlink" title="4、Delete a article"></a>4、Delete a article</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">article = Article.get(id=<span class="number">1</span>)</div><div class="line">article.delete()</div></pre></td></tr></table></figure>
<p>=&gt; Restful API<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">http DELETE http://127.0.0.1:9200/blog/article/1</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Length: 71</div><div class="line">Content-Type: application/json; charset=UTF-8</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;_id&quot;: &quot;1&quot;, </div><div class="line">    &quot;_index&quot;: &quot;blog&quot;, </div><div class="line">    &quot;_type&quot;: &quot;article&quot;, </div><div class="line">    &quot;_version&quot;: 4, </div><div class="line">    &quot;found&quot;: true</div><div class="line">&#125;</div><div class="line"></div><div class="line">http HEAD  http://127.0.0.1:9200/blog/article/1</div><div class="line">HTTP/1.1 404 Not Found</div><div class="line">Content-Length: 0</div><div class="line">Content-Type: text/plain; charset=UTF-8</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/30/python-face-recognition/" itemprop="url">
                  基于 Python 的开源人脸识别库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-07-30T10:41:00+08:00" content="2017-07-30">
              2017-07-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/07/30/python-face-recognition/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/30/python-face-recognition/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h3 id="项目说明"><a href="#项目说明" class="headerlink" title="项目说明"></a>项目说明</h3><p>该库使用 dlib 顶尖的深度学习人脸识别技术构建，在户外脸部检测数据库基准（Labeled Faces in the Wild benchmark）上的准确率高达 99.38%。<br>该项目是要构建一款免费、开源、实时、离线的网络 app，支持组织者使用人脸识别技术或二维码识别所有受邀人员。有了世界上最简单的人脸识别库，使用 Python 或命令行，即可识别和控制人脸。</p>
<p>项目地址：<br><a href="https://github.com/ageitgey/face_recognition#face-recognition" target="_blank" rel="external">https://github.com/ageitgey/face_recognition#face-recognition</a></p>
<h3 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h3><h4 id="1、从图片中识别出人脸"><a href="#1、从图片中识别出人脸" class="headerlink" title="1、从图片中识别出人脸"></a>1、从图片中识别出人脸</h4><p><img src="/imgs/20170729/42c65360-025d-11e7-94ea-b12f28cb34b4.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> face_recognition</div><div class="line">image = face_recognition.load_image_file(<span class="string">"your_file.jpg"</span>)</div><div class="line">face_locations = face_recognition.face_locations(image)</div></pre></td></tr></table></figure>
<h4 id="2、从图片中识别面部特征，比如：眼睛-鼻子-嘴和下巴。"><a href="#2、从图片中识别面部特征，比如：眼睛-鼻子-嘴和下巴。" class="headerlink" title="2、从图片中识别面部特征，比如：眼睛, 鼻子, 嘴和下巴。"></a>2、从图片中识别面部特征，比如：眼睛, 鼻子, 嘴和下巴。</h4><p><img src="/imgs/20170729/7f2d79dc-025d-11e7-8728-d8924596f8fa.png" alt=""><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> face_recognition</div><div class="line">image = face_recognition.load_image_file(<span class="string">"your_file.jpg"</span>)</div><div class="line">face_landmarks_list = face_recognition.face_landmarks(image)</div></pre></td></tr></table></figure></p>
<h4 id="3、可以对识别的面部特征进行处理，比如类似美图秀秀的功能"><a href="#3、可以对识别的面部特征进行处理，比如类似美图秀秀的功能" class="headerlink" title="3、可以对识别的面部特征进行处理，比如类似美图秀秀的功能"></a>3、可以对识别的面部特征进行处理，比如类似美图秀秀的功能</h4><p><img src="/imgs/20170729/80638760-025d-11e7-80a2-1d2779f7ccab.png" alt=""></p>
<h4 id="4、从图片中识别出某个具体的人"><a href="#4、从图片中识别出某个具体的人" class="headerlink" title="4、从图片中识别出某个具体的人"></a>4、从图片中识别出某个具体的人</h4><p><img src="/imgs/20170729/45e049b6-025d-11e7-89cc-8a71cf89e713.png" alt=""><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> face_recognition</div><div class="line">known_image = face_recognition.load_image_file(<span class="string">"biden.jpg"</span>)</div><div class="line">unknown_image = face_recognition.load_image_file(<span class="string">"unknown.jpg"</span>)</div><div class="line"></div><div class="line">biden_encoding = face_recognition.face_encodings(known_image)[<span class="number">0</span>]</div><div class="line">unknown_encoding = face_recognition.face_encodings(unknown_image)[<span class="number">0</span>]</div><div class="line"></div><div class="line">results = face_recognition.compare_faces([biden_encoding], unknown_encoding)</div></pre></td></tr></table></figure></p>
<p>更多请查看项目主页：</p>
<p><a href="https://github.com/ageitgey/face_recognition#face-recognition" target="_blank" rel="external">https://github.com/ageitgey/face_recognition#face-recognition</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/29/database-sharding/" itemprop="url">
                  数据库分库分表
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-07-29T13:44:00+08:00" content="2017-07-29">
              2017-07-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Database/" itemprop="url" rel="index">
                    <span itemprop="name">Database</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/07/29/database-sharding/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/29/database-sharding/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h3 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h3><ul>
<li>大量的并发读/写操作，导致单库出现难以承受的负载压力</li>
<li>单表存储数据量过大，导致索引效率低下</li>
</ul>
<h3 id="二、读写分离"><a href="#二、读写分离" class="headerlink" title="二、读写分离"></a>二、读写分离</h3><p>将数据库设置为读写分离状态，由Master（主）负责写数据，Salve（从）只负责读数据。主从之间保持数据同步。根据二八法则，80%的数据库操作是读，20%则为写。读写分离后，可以大大提升单库负载压力。</p>
<p><strong>但是，当Master存在TPS（系统吞吐量）较高的情况，Master和Slave数据库之间数据同步是会存在一定延迟，因此在写入Master之前最好还是要将同一份数据放入缓存中，以避免高并发情况下，从Slave中获取不到指定数据的情况</strong></p>
<h3 id="三、分库分表"><a href="#三、分库分表" class="headerlink" title="三、分库分表"></a>三、分库分表</h3><p>随着用户规模的不断上升，仅仅只是依靠数据库的读写分离并不能解决系统瓶颈。因此需要考虑分库分表的解决方案。</p>
<p><strong>分表</strong> 就是将原来冗余在单库中的单个业务表拆分为N个“逻辑相关”的业务子表（如tab_0000, tab_0001, tab_0002…），不同的业务字表各自负责存储不同区间数据，对外形成一个整体</p>
<p><strong>分库</strong> 就是将分表后的业务子表按照特定的算法和规则分散到N个“逻辑相关”的业务子库中（如db_0000, db_0001, db_0002…）</p>
<h4 id="分库分表策略"><a href="#分库分表策略" class="headerlink" title="分库分表策略"></a>分库分表策略</h4><p>主要原理：<strong>分区，取模，数据路由表</strong></p>
<h4 id="1、按时间区间"><a href="#1、按时间区间" class="headerlink" title="1、按时间区间"></a>1、按时间区间</h4><p>一定时间区间内产生的数据放到一张表里面，多个时间区间的表放到一个库里面</p>
<p>比如，</p>
<p>a、单库多表结构，按月分表可以这样：user_201701, user_201702…user_201712；按年分表可以这样，user_2016, user_2017…</p>
<p>b、多库多表，比如按天分表，每天一张表，当单库超过100张表的时候，进行分库到下一张表。那么假如第一张表在库db0，表名是user_20160201。从db0.user_20160201 - db0.user_20160511就是100张表了，接下来就是分库，进入20160512，就是db1.user_20160512，这个算法就是上线的时候定一个上线日期，具体算法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">库ID = （当前日期 - 上线日期）/ 100</div><div class="line">表ID = user_yyyyMMdd</div></pre></td></tr></table></figure>
<p><strong>注：好处是可以直接根据时间经过简单计算定位到哪个库和哪个表</strong></p>
<p>还有一种算法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">表ID = (当前日期 - 上线日期) % 100</div><div class="line">表名如下： DB0.user_0001，user_0002 .... user_01000</div></pre></td></tr></table></figure></p>
<p><strong>注：表名和库名都要经过计算，比较麻烦</strong></p>
<p>c、按月分表，每个月一张表。这种情况，一般就不用分库了，一年12张表说明量也不会特别大，如果量特别大，或者是热点数据，可以一年分一个库，具体算法和上面差不多。</p>
<p>d、按季度分表，按年度分表（基本不用分库）</p>
<h4 id="2、按主键ID区间"><a href="#2、按主键ID区间" class="headerlink" title="2、按主键ID区间"></a>2、按主键ID区间</h4><p>对于自增的主键ID，可以按照ID区间进行分表，以1000万数据量为分界线，对线性的ID进行切割分表，每涨到1000万数据，分到下一张表，超过一定数目的表，进行分库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">库ID = 主键ID / 1000万 / 100</div><div class="line">表ID = 主键ID / 1000万 % 100</div></pre></td></tr></table></figure>
<p>如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">db0.user_0000 ... db0.user_0099 </div><div class="line">db1.user_0000 ... db1.user_0099</div></pre></td></tr></table></figure>
<h4 id="3、按照用户ID取模"><a href="#3、按照用户ID取模" class="headerlink" title="3、按照用户ID取模"></a>3、按照用户ID取模</h4><p>这里把按照用户ID取模单独拎出来，因为就使用而言，是使用场景最多的情况，很多时候都是用户相关数据量最大，需要分库分表，查询维度更多也是按照用户来查询，所以对用户取模，让同一个用户的数据落到一张表里面，再好不过了。</p>
<p>这里模式用户ID是整数型的。假设库数量要分4库，每个库表数量8表，一共32张表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">库ID = userId % 库数量4</div><div class="line">表ID = userId / 库数量4 % 表数量8</div><div class="line">或者</div><div class="line">库ID = userId / 表数量4 % 库数量4</div><div class="line">表ID = userId % 表数量8</div></pre></td></tr></table></figure>
<h4 id="4、按照指定字段hash后再取模"><a href="#4、按照指定字段hash后再取模" class="headerlink" title="4、按照指定字段hash后再取模"></a>4、按照指定字段hash后再取模</h4><p>如果要取模的字段不是整数型，要先hash后，再通过取模算法，算出在哪个库和那个表。具体算法，参照上面的按用户ID取模。</p>
<h4 id="5、数据路由表"><a href="#5、数据路由表" class="headerlink" title="5、数据路由表"></a>5、数据路由表</h4><p>如果分库分表的算法很复杂，可以通过路由表+程序算法，来存储和计算分库分表规则，不过一般不建议，分库分表搞得太复杂，不便于维护和查询问题</p>
<h3 id="四、第三方中间件"><a href="#四、第三方中间件" class="headerlink" title="四、第三方中间件"></a>四、第三方中间件</h3><p>1、Cobar</p>
<p>开源地址：<a href="https://github.com/alibaba/cobar" target="_blank" rel="external">https://github.com/alibaba/cobar</a></p>
<p>2、Shark</p>
<p>开源地址：<a href="https://github.com/gaoxianglong/shark" target="_blank" rel="external">https://github.com/gaoxianglong/shark</a></p>
<h3 id="五、需要考虑的问题"><a href="#五、需要考虑的问题" class="headerlink" title="五、需要考虑的问题"></a>五、需要考虑的问题</h3><p>一旦数据库实施分库分表后，便会对开发造成一定的影响。具体问题如下：</p>
<ul>
<li>数据的原子性，一致性，隔离性，持久性如何保证</li>
<li>多表之间的关联查询如何进行</li>
<li>无法继续使用外键约束</li>
<li>无法继续使用Oracle提供的Sequence或MySQL提供的AUTO_INCREMENT生成全局唯一和连续性ID。</li>
</ul>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ul>
<li><a href="https://baijiahao.baidu.com/s?id=1564548884823698&amp;wfr=spider&amp;for=pc" target="_blank" rel="external">https://baijiahao.baidu.com/s?id=1564548884823698&amp;wfr=spider&amp;for=pc</a></li>
<li><a href="http://blog.csdn.net/xlgen157387/article/details/53976153" target="_blank" rel="external">http://blog.csdn.net/xlgen157387/article/details/53976153</a></li>
<li><a href="http://blog.csdn.net/dinglang_2009/article/details/53195871" target="_blank" rel="external">http://blog.csdn.net/dinglang_2009/article/details/53195871</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/02/scrapy-deploy-usage/" itemprop="url">
                  Scrapy 部署笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-07-02T10:41:00+08:00" content="2017-07-02">
              2017-07-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/scrapy/" itemprop="url" rel="index">
                    <span itemprop="name">scrapy</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/scrapy/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/07/02/scrapy-deploy-usage/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/02/scrapy-deploy-usage/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>关键字：</p>
<p><strong>scrapy</strong>， <strong>scrapyd</strong>， <strong>scrapy-client</strong>， <strong>spiderkeeper</strong></p>
<h4 id="一、新建一个scrapy项目"><a href="#一、新建一个scrapy项目" class="headerlink" title="一、新建一个scrapy项目"></a>一、新建一个scrapy项目</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ scrapy startproject scrapy_example</div><div class="line">$ cd scrapy_example</div><div class="line"></div><div class="line"># 修改配置文件scrapy.cfg</div><div class="line">[settings]</div><div class="line">default = scrapy_example.settings</div><div class="line"></div><div class="line">[deploy:scrapyd1]</div><div class="line">url = http://localhost:6800/</div><div class="line">project = scrapy_example</div></pre></td></tr></table></figure>
<h4 id="二、安装并启动scrapyd"><a href="#二、安装并启动scrapyd" class="headerlink" title="二、安装并启动scrapyd"></a>二、安装并启动scrapyd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ pip install scrapyd</div><div class="line"></div><div class="line"># 启动, 默认的端口是6800。可以在浏览器中查看结果，比如：http://127.0.0.1:6800/。</div><div class="line">$ scrapyd</div></pre></td></tr></table></figure>
<h4 id="三、发布工程到scrapyd"><a href="#三、发布工程到scrapyd" class="headerlink" title="三、发布工程到scrapyd"></a>三、发布工程到scrapyd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 发布scrapyd需要安装scrapy-client</div><div class="line">$ pip install scrapy-client</div><div class="line"># 发布命令：scrapyd-deploy &lt;target&gt; -p &lt;project&gt;</div><div class="line">$ scrapyd-deploy scrapyd1 -p scrapy_example</div><div class="line"></div><div class="line"># 检查发布是否成功</div><div class="line">$ scrapyd-deploy -l 或者 scrapyd-deploy -L scrapyd1</div><div class="line"></div><div class="line"># 启动爬虫</div><div class="line">$ curl http://127.0.0.1:6800/schedule.json -d project=scrapy_example -d spider=example</div></pre></td></tr></table></figure>
<h4 id="四、使用spiderkeeper发布爬虫"><a href="#四、使用spiderkeeper发布爬虫" class="headerlink" title="四、使用spiderkeeper发布爬虫"></a>四、使用spiderkeeper发布爬虫</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 生成egg文件</div><div class="line">$ scrapyd-deploy --build-egg scrapy_example.egg</div><div class="line"></div><div class="line"># 安装spiderkeeper(https://github.com/DormyMo/SpiderKeeper)</div><div class="line"># pip install spiderkeeper</div><div class="line"># 启动spiderkeeper</div><div class="line">$ spiderkeeper --server=http://localhost:6800</div><div class="line"></div><div class="line"># 访问 http://localhost:5000</div><div class="line"># 这个时候可以在spiderkepper上传scrapy_example.egg文件，通过Web UI启动，监控爬虫</div></pre></td></tr></table></figure>
<h4 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h4><p><a href="http://www.cnblogs.com/jinhaolin/p/5033733.html" target="_blank" rel="external">http://www.cnblogs.com/jinhaolin/p/5033733.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/22/docker-build-and-run-your-first-app/" itemprop="url">
                  Docker 构建第一个App
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-06-22T23:45:00+08:00" content="2017-06-22">
              2017-06-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/06/22/docker-build-and-run-your-first-app/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/22/docker-build-and-run-your-first-app/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>测试环境：阿里云 ubuntu14.04 </p>
<h4 id="一、新建Dockerfile文件"><a href="#一、新建Dockerfile文件" class="headerlink" title="一、新建Dockerfile文件"></a>一、新建Dockerfile文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># Use an official Python runtime as a base image</div><div class="line">FROM python:2.7-slim</div><div class="line"></div><div class="line"># Set the working directory to /app</div><div class="line">WORKDIR /app</div><div class="line"></div><div class="line"># Copy the current directory contents into the container at /app</div><div class="line">ADD . /app</div><div class="line"></div><div class="line"># Install any needed packages specified in requirements.txt</div><div class="line">RUN pip install -r requirements.txt</div><div class="line"></div><div class="line"># Make port 80 available to the world outside this container</div><div class="line">EXPOSE 80</div><div class="line"></div><div class="line"># Define environment variable</div><div class="line">ENV NAME World</div><div class="line"></div><div class="line"># Run app.py when the container launches</div><div class="line">CMD [&quot;python&quot;, &quot;app.py&quot;]</div></pre></td></tr></table></figure>
<h4 id="二、新建requirements-txt"><a href="#二、新建requirements-txt" class="headerlink" title="二、新建requirements.txt"></a>二、新建requirements.txt</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Flask</div><div class="line">Redis</div></pre></td></tr></table></figure>
<h4 id="三、新建app-py"><a href="#三、新建app-py" class="headerlink" title="三、新建app.py"></a>三、新建app.py</h4><pre><code>from flask import Flask
from redis import Redis, RedisError
import os
import socket

# Connect to Redis
redis = Redis(host=&quot;redis&quot;, db=0, socket_connect_timeout=2, socket_timeout=2)

app = Flask(__name__)

@app.route(&quot;/&quot;)
def hello():
    try:
        visits = redis.incr(&quot;counter&quot;)
    except RedisError:
        visits = &quot;&lt;i&gt;cannot connect to Redis, counter disabled&lt;/i&gt;&quot;

    html = &quot;&lt;h3&gt;Hello {name}!&lt;/h3&gt;&quot; \
           &quot;&lt;b&gt;Hostname:&lt;/b&gt; {hostname}&lt;br/&gt;&quot; \
           &quot;&lt;b&gt;Visits:&lt;/b&gt; {visits}&quot;
    return html.format(name=os.getenv(&quot;NAME&quot;, &quot;world&quot;), hostname=socket.gethostname(), visits=visits)

if __name__ == &quot;__main__&quot;:
    app.run(host=&apos;0.0.0.0&apos;, port=80)
</code></pre><h4 id="四、编译"><a href="#四、编译" class="headerlink" title="四、编译"></a>四、编译</h4><blockquote>
<p>ls  </p>
<p>docker build -t friendlyhello . (当前目录)</p>
<p>docker images</p>
</blockquote>
<h4 id="五、运行"><a href="#五、运行" class="headerlink" title="五、运行"></a>五、运行</h4><blockquote>
<p>docker run -p 4000:80 friendlyhello</p>
</blockquote>
<h4 id="六、测试"><a href="#六、测试" class="headerlink" title="六、测试"></a>六、测试</h4><blockquote>
<p>curl <a href="http://localhost:4000" target="_blank" rel="external">http://localhost:4000</a></p>
</blockquote>
<h4 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h4><p><a href="https://docs.docker.com/get-started/part2/#run-the-app" target="_blank" rel="external">https://docs.docker.com/get-started/part2/#run-the-app</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/22/supervisord-usage/" itemprop="url">
                  Supervisord 使用笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-06-22T23:40:00+08:00" content="2017-06-22">
              2017-06-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/06/22/supervisord-usage/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/22/supervisord-usage/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h4 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- pip install supervisor  </div><div class="line">- echo_supervisord_conf  #或者  </div><div class="line">- echo_supervisord_conf &gt; supervisord.conf  </div><div class="line">- supervisord -c ./supervisord.conf</div></pre></td></tr></table></figure>
<h4 id="二、遇到错误"><a href="#二、遇到错误" class="headerlink" title="二、遇到错误"></a>二、遇到错误</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# supervisord -c ./supervisord.conf   </div><div class="line">Error: .ini file does not include supervisord section  </div><div class="line">For help, use /usr/bin/supervisord -h</div></pre></td></tr></table></figure>
<p><strong>错误原因是因为配置文件少了 [supervisrod] 配置项</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[program:djangotest]  </div><div class="line">user=lzz  </div><div class="line">command=/usr/bin/python /var/www/djangotest/manage.py runserver 0.0.0.0:8000  </div><div class="line">autostart=true  </div><div class="line">autorestart=true  </div><div class="line">stderr_logfile=/var/logs/err.log  </div><div class="line">stdout_logfile=/var/logs/out.log  </div><div class="line">stopsignal=INT  </div><div class="line">   </div><div class="line">[supervisord]</div></pre></td></tr></table></figure></p>
<h4 id="三、常用命令"><a href="#三、常用命令" class="headerlink" title="三、常用命令"></a>三、常用命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">supervisord : supervisor的服务器端部分，用于supervisor启动</div><div class="line">supervisorctl：启动supervisor的命令行窗口，在该命令行中可执行start、stop、status、reload等操作。</div></pre></td></tr></table></figure>
<h4 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h4><p><a href="http://www.jianshu.com/p/9abffc905645" target="_blank" rel="external">http://www.jianshu.com/p/9abffc905645</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/27/ubuntu-install-svn-simple-server/" itemprop="url">
                  Ubuntu 安装svn服务
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-01-27T20:56:00+08:00" content="2017-01-27">
              2017-01-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Note/" itemprop="url" rel="index">
                    <span itemprop="name">Note</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/01/27/ubuntu-install-svn-simple-server/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/27/ubuntu-install-svn-simple-server/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、安装Subversion-Server"><a href="#一、安装Subversion-Server" class="headerlink" title="一、安装Subversion Server"></a>一、安装Subversion Server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt-get install subversion</div></pre></td></tr></table></figure>
<h3 id="二、创建SVN版本库"><a href="#二、创建SVN版本库" class="headerlink" title="二、创建SVN版本库"></a>二、创建SVN版本库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir /srv/svn          # 创建SVN根目录</div><div class="line">svnadmin create test    # 创建测试项目库</div></pre></td></tr></table></figure>
<h3 id="三、SVN配置"><a href="#三、SVN配置" class="headerlink" title="三、SVN配置"></a>三、SVN配置</h3><p>主要包含以下三个配置文件：</p>
<h5 id="1-svnserve-conf"><a href="#1-svnserve-conf" class="headerlink" title="1. svnserve.conf"></a>1. svnserve.conf</h5><p>服务配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[general]</div><div class="line">anon-access = none      # 匿名用户不可读</div><div class="line">auth-access = write     # 权限用户可写</div><div class="line">password-db = passwd    # 启用密码文件</div><div class="line">authz-db = authz        # 启用权限文件</div><div class="line">realm = repos           # 认证域名称</div></pre></td></tr></table></figure></p>
<h5 id="2-passwd"><a href="#2-passwd" class="headerlink" title="2. passwd"></a>2. passwd</h5><p>账号配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[user]</div><div class="line">finger = 123456</div></pre></td></tr></table></figure></p>
<h5 id="3-authz"><a href="#3-authz" class="headerlink" title="3. authz"></a>3. authz</h5><p>权限配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[groups]</div><div class="line">admin = finger</div><div class="line"></div><div class="line">[/]</div><div class="line">@admin = rw         # admin组拥有所有读写权限</div><div class="line">* = r               # 其他只有读权限</div></pre></td></tr></table></figure></p>
<h3 id="四、启动和停止"><a href="#四、启动和停止" class="headerlink" title="四、启动和停止"></a>四、启动和停止</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">启动：</div><div class="line">svnserve -d -r /srv/svn   # -d 表示后台运行 -r 表示根目录</div><div class="line"></div><div class="line">停止：</div><div class="line">ps -ef | grep svn   # 查看svn进程ID</div><div class="line"></div><div class="line">kill -9 进程ID</div></pre></td></tr></table></figure>
<h3 id="五、测试"><a href="#五、测试" class="headerlink" title="五、测试"></a>五、测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn co svn://127.0.0.1/test</div></pre></td></tr></table></figure>
<h3 id="六、问题"><a href="#六、问题" class="headerlink" title="六、问题"></a>六、问题</h3><p><strong>1、svn: E220003: Invalid authz configuration</strong></p>
<p>原因是authz文件配置错误，仔细检查authz文件。</p>
<h3 id="七、参考文献"><a href="#七、参考文献" class="headerlink" title="七、参考文献"></a>七、参考文献</h3><p><a href="https://my.oschina.net/jast90/blog/382688" target="_blank" rel="external">https://my.oschina.net/jast90/blog/382688</a></p>
<p><a href="http://www.linuxidc.com/Linux/2015-01/111956.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2015-01/111956.htm</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/27/hexo-usage/" itemprop="url">
                  Hexo使用笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-01-27T20:40:00+08:00" content="2017-01-27">
              2017-01-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Note/" itemprop="url" rel="index">
                    <span itemprop="name">Note</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/01/27/hexo-usage/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/27/hexo-usage/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="中文文档："><a href="#中文文档：" class="headerlink" title="中文文档："></a>中文文档：</h4><p><a href="https://hexo.io/zh-cn/docs/index.html" target="_blank" rel="external">https://hexo.io/zh-cn/docs/index.html</a></p>
<p><strong>参考博客：</strong><br><a href="http://blog.csdn.net/poem_of_sunshine/article/details/29369785/" target="_blank" rel="external">http://blog.csdn.net/poem_of_sunshine/article/details/29369785/</a><br><a href="http://www.jianshu.com/p/465830080ea9#" target="_blank" rel="external">http://www.jianshu.com/p/465830080ea9#</a><br><a href="http://www.jianshu.com/p/a2023a601ceb" target="_blank" rel="external">http://www.jianshu.com/p/a2023a601ceb</a></p>
<p><strong>Github配置：</strong><br><a href="https://help.github.com/articles/generating-an-ssh-key/" target="_blank" rel="external">https://help.github.com/articles/generating-an-ssh-key/</a><br><a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/" target="_blank" rel="external">https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/</a></p>
<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">hexo server | s --debug</div><div class="line">hexo clean</div><div class="line">hexo generate</div><div class="line">hexo deploy</div></pre></td></tr></table></figure>
<p>绑定阿里云域名：<br><a href="http://quantumman.me/blog/setting-up-a-domain-with-gitHub-pages.html" target="_blank" rel="external">http://quantumman.me/blog/setting-up-a-domain-with-gitHub-pages.html</a></p>
<h4 id="后端管理插件hexo-admin"><a href="#后端管理插件hexo-admin" class="headerlink" title="后端管理插件hexo-admin"></a>后端管理插件hexo-admin</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">npm install --save hexo-admin</div><div class="line">hexo server -d</div><div class="line">open http://localhost:4000/admin/</div></pre></td></tr></table></figure>
<p><strong>设置后台密码</strong><br>修改站点配置文件，就是网站根目录下的 _config.yml文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">admin:</div><div class="line">  username: finger</div><div class="line">  password_hash: $2a$1$Cof3VuvY8nKKIUjeCNBSE.HjcrCKQ1P80GEegP//SLDFWZoGzm4pa</div><div class="line">  secret: a secret something</div></pre></td></tr></table></figure></p>
<ul>
<li>username：后端登录用户名</li>
<li>password_hash：后端登录用户密码对应的md5 hash值</li>
<li>secret：用于保证cookie安全</li>
</ul>
<p><strong>密码生成</strong><br>hexo-admin密码是bcrypt编码。因此需要安装bcrypt-nodejs模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ node</div><div class="line">&gt; const bcrypt = require(&apos;bcrypt-nodejs&apos;)</div><div class="line">&gt; bcrypt.hashSync(&apos;your password secret here!&apos;)</div><div class="line">//=&gt; &apos;$2a$10$8f0CO288aEgpb0BQk0mAEOIDwPS.s6nl703xL6PLTVzM.758x8xsi&apos;</div></pre></td></tr></table></figure></p>
<p><strong>在线生成</strong><br><a href="https://www.bcrypt-generator.com/" target="_blank" rel="external">https://www.bcrypt-generator.com/</a></p>
<h4 id="Hexo主题："><a href="#Hexo主题：" class="headerlink" title="Hexo主题："></a>Hexo主题：</h4><ul>
<li><a href="https://hexo.io/themes/" target="_blank" rel="external">https://hexo.io/themes/</a></li>
<li><a href="https://github.com/henryhuang/oishi" target="_blank" rel="external">https://github.com/henryhuang/oishi</a></li>
<li><a href="https://github.com/haojen/hexo-theme-Anisina" target="_blank" rel="external">https://github.com/haojen/hexo-theme-Anisina</a></li>
<li><a href="https://github.com/stiekel/hexo-theme-random" target="_blank" rel="external">https://github.com/stiekel/hexo-theme-random</a></li>
<li><a href="https://github.com/SuperKieran/TKL" target="_blank" rel="external">https://github.com/SuperKieran/TKL</a></li>
<li><a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="external">https://github.com/iissnan/hexo-theme-next</a></li>
</ul>
<h4 id="Next-皮肤设置"><a href="#Next-皮肤设置" class="headerlink" title="Next 皮肤设置"></a>Next 皮肤设置</h4><p><a href="http://theme-next.iissnan.com/theme-settings.html" target="_blank" rel="external">http://theme-next.iissnan.com/theme-settings.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/27/cocos2dx-upload-google-play/" itemprop="url">
                  Cocos2dx－上传Google Play遇到的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-01-27T20:40:00+08:00" content="2017-01-27">
              2017-01-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Cocos2d-x/" itemprop="url" rel="index">
                    <span itemprop="name">Cocos2d-x</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/01/27/cocos2dx-upload-google-play/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/27/cocos2dx-upload-google-play/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="一、OpenSSL版本有多个安全漏洞，建议您尽快更新-OpenSSL"><a href="#一、OpenSSL版本有多个安全漏洞，建议您尽快更新-OpenSSL" class="headerlink" title="一、OpenSSL版本有多个安全漏洞，建议您尽快更新 OpenSSL"></a>一、OpenSSL版本有多个安全漏洞，建议您尽快更新 OpenSSL</h4><hr>
<p>因为项目使用的是cocos2d-x 3.3版本。因此cocos2d-x第三方库比较旧。上传Google Play 后台时被rejected。邮件原文如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">Vulnerability</div><div class="line">-----------------------------------------------------------</div><div class="line">**OpenSSL**</div><div class="line"></div><div class="line">The vulnerabilities were addressed in OpenSSL 1.0.2f/1.0.1r. To confirm your OpenSSL version, you can do a grep search for:</div><div class="line"></div><div class="line">\$ unzip -p YourApp.apk | strings | grep &quot;OpenSSL&quot;</div><div class="line"></div><div class="line">You can find more information and next steps in this Google Help Center article.</div><div class="line">-----------------------------------------------------------</div><div class="line"></div><div class="line">To confirm you’ve upgraded correctly, submit the updated version of your app to the Play Console and check back after five hours to make sure the warning is gone.</div><div class="line"></div><div class="line">While these vulnerabilities may not affect every app that uses this software, it’s best to stay up to date on all security patches. Make sure to update any libraries in your app that have known security issues, even if you&apos;re not sure the issues are relevant to your app.</div><div class="line"></div><div class="line">Apps must also comply with the Developer Distribution Agreement and Developer Program Policies.</div><div class="line"></div><div class="line">If you feel we have made this determination in error, please reach out to our developer support team.</div><div class="line"></div><div class="line">Best,</div><div class="line"></div><div class="line">The Google Play Team</div></pre></td></tr></table></figure>
<p><strong>解决方案</strong></p>
<p>邮件写的很清楚，主要是OpenSSL的库版本太低，存在漏洞。cocos论坛上也有很多同学遇到类似的问题，传送门：<a href="http://discuss.cocos2d-x.org/t/the-vulnerabilities-were-addressed-in-openssl-1-0-2f-1-0-1r/35766/9" target="_blank" rel="external">http://discuss.cocos2d-x.org/t/the-vulnerabilities-were-addressed-in-openssl-1-0-2f-1-0-1r/35766/9</a></p>
<p>具体做法，就是从cocos的第三方库下载最新的curl库替换当前项目的curl。</p>
<p><a href="https://github.com/cocos2d/cocos2d-x-3rd-party-libs-bin" target="_blank" rel="external">https://github.com/cocos2d/cocos2d-x-3rd-party-libs-bin</a></p>
<h4 id="二、Google-Play支付-in-app-Billing"><a href="#二、Google-Play支付-in-app-Billing" class="headerlink" title="二、Google Play支付(in-app Billing)"></a>二、Google Play支付(in-app Billing)</h4><p><strong>注意：在测试之前一定要注意后台APK版本号、签名，一定要与测试用的APK版本号签名一致</strong></p>
<p>1、错误提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">1. &quot;需要验证身份，您需要登录自己google账号&quot; // 没有成功发布apk测试(Alpha)版本</div><div class="line">2. &quot;无法购买您要买的商品&quot; // 已成功发布Alpah版本。需要等待生效</div></pre></td></tr></table></figure>
<p>2、系统异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalStateException: Can&apos;t start async operation (launchPurchaseFlow)</div><div class="line"></div><div class="line">// 解决方法</div><div class="line">// 1、mHelper.flagEndAsync() 修改成public</div><div class="line">// 2、在launchPurchaseFlow() 之前调用flagEndAsync()</div><div class="line">----------------------------------------------------</div><div class="line">if (mHelper != null) &#123;</div><div class="line">    try &#123;</div><div class="line">        mHelper.flagEndAsync();</div><div class="line">        mHelper.launchPurchaseFlow(this, item, RC_REQUEST, mPurchaseFinishedListener, &quot;&quot;);</div><div class="line">    &#125;       </div><div class="line">    catch(IllegalStateException ex)&#123;</div><div class="line">        Toast.makeText(this, &quot;Please retry in a few seconds.&quot;, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Finger Chou" />
          <p class="site-author-name" itemprop="name">Finger Chou</p>
          <p class="site-description motion-element" itemprop="description">If we dream, everything is possible.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">9</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zhoujun" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/hifinger" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://douban.com/people/junzhou" target="_blank" title="Douban">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Douban
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Finger Chou</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"junzhou"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

</body>
</html>
